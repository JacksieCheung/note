## mysql 存储引擎

mysql存储访问数据是通过存储引擎来处理的。mysql有几种类型的存储引擎：InnoDB MyISAM Memory等。我们用的最多的就是InnoDB。

## InnoDB 页简介

mysql 将数据存储在磁盘。但是真正处理数据的过程是发生在内存中的，所以内存和磁盘需要读取和刷新。但是我们读写磁盘的速度非常慢，和内存读写差了几个数量级。所以 InnoDB 读取磁盘的方式是将将数据分成若干个页，以页作为磁盘和内存之间的交换。

InnoDB中页的大小一般未16kb。也就是说mysql一次将16kb的数据刷到磁盘或者从磁盘读取。

## InnoDB 行格式

mysql是以记录为单位来向表中插入数据的。这些记录在磁盘上的存放方式也被称为行格式或者记录格式。InnoDB有四种行格式：Compact Redundant Dynamic Compressed

指定行格式用 `ROW_FORMAT=` 选项

### COMPACT 行格式

一条完整的数据可以分为记录额外信息和记录真实数据两个部分

#### 记录额外信息

这部分信息是服务器为了描述这条记录而不得不额外添加的一些信息

这个信息又可以分成三个部分：变长字段长度列表|NULL值列表|记录头信息

下面我们一一来看。

**变长字段长度列表**

mysql支持一些变长的数据类型 如 VARCHAR VARBINARY TEXT BLOB 等。

我们可以把又有这些数据类型的列称为变长字段。变长字段中存储多少字节的数据是不固定的。

所以我们存储真实数据的时候要顺便把这些数据占用的字节数也存起来，方便mysql查找

所以变长字段占用的存储空间可以分为两部分：真正的数据内容 和 占用的字节数

compact格式中，所有变长字段的真实数据所占用的字节长度都存放在记录的开头部分。形成一个变长字段的长度列表。各变长字段数据占用的字节树按照**逆序存放**。

存储这样一个列表需要的字节数需要视情况而定。如果这个可变字段的最大字节数超过255字节，并且真实存储的字节数超过127字节。那么就使用2个字节存储，否则使用一个字节

变长字段长度列表只存储非NULL的列内容。NULL值长度是不存储的，因为后面有一个NULL之列表。

**NULL值列表**

mysql 会先统计表中哪些列允许存储NULL。然后每个允许存储NULL的列在这个NULL值列表中对应一个二进制位（NOT NULL的列不对应）。二进制位按照列的顺序逆序排列。

二进制位为1代表该列的值为NULL

二进制位为0代表该列的值不为NULL

NULL值列表必须用整数个字节表示，多处来的位补0。

**记录头信息**

最后一部分是这个记录头信息。

这部分由五个字节组成。五个字节也就是40个二进制位，分成了8个部分。

#### 记录真实数据

**隐藏字段**

除了记录真实数据，mysql还会在记录真实数据的左侧，也就是和额外信息的交界处，存放三个隐藏字段：行ID 事务ID 回滚指针。

其中行ID是唯一标志这个行的符号。但是不是必须的，它受到mysql选取主键的策略影响。主键选取优先用户定义，如果没有定义，则任选一个定义了unique的列。如果都没有，那么就自动生成，这里自动生成的，就是这么一个行ID。

**char(M)列的存储格式**

当用定长字符集，如ASCII时，char(M)的长度是固定的。但是如果使用非定长字符集，那么就不是固定的。此时这个字段仍然会存到变长字段列表。char(M)规定至少存放M个字符。多出的字节用空格补齐。也就是说如果是utf8字符集，那么char(10)就能存放10-30个字节。varchar(M)没有这个要求。

char(M) 要求存的真实数据空间是`M*该字符集最大字节数`

#### 行溢出数据

**varchar(M)的存储字符数**

mysql规定，一条记录的字节长度（不包含BLOB或者TEXT类型的列，也不包含隐藏列和记录头信息）不能超过65535个字节。

所以如果只有一列的varchar(M)包含了三个部分：真实数据、真实数据占用字节长度和NULL值标志（如果没有NOT NULL）。

其中真实数据占用长度要两个字节，NULL要一个字节

所以真实数据最多占用65532个字节。

在这之后，真实数据的字符数需要看字符集的编码方式，比如ASCII用一个字节，gbk两个字节，utf8三个字节。对应的能存储的字符数量就是 65532、65532/2、65532/3。

**溢出**

mysql和磁盘的内存交换的基本单位是页。一页的基本单位是16kb。也就是16384字节。但是上面说到了一个varchar(M)最多可以存储65532个字节。这样就造成了一个内存放不下一条记录的情况。。
