# 2021 木犀 lab

## 11.网络编程(打\*为了解内容)

### 网络协议体系结构

网络协议的结构一般有七层和五层两种划分方法。它们内容是类似的，下面讲的协议体系结构默认都是五层。

> 什么叫协议呢？简单来说就是每一层要做什么的规定或者标准。

五层协议自上到下分为 应用层、运输层、网络层、数据链路层和物理层。

* 应用层协议：

  应用层的任务是通过应用进程之间的交互来完成特定网络应用

  有 http、ftp、smtp等

* 运输层协议：

  运输层负责向两台主机中进程之间的通信提供通用的数据传输服务

  有 TCP、UDP

* 网络层协议：IP、网际协议IP

* 数据链路层协议：CSMA/CD、PPP

* 物理层协议：如下图:（摘自维基百科）

![](/Users/jacksie/Documents/note/other/csapp lab/物理层协议.png)

上述列举的协议只是一小部分。

很明显，在 csapp 的学习中，不可能把 计网 也给你学了。我没有这个能力给你讲清楚，也讲不完。这个留到你们以后学计网再深入学习。

不过还是有一些点可以提一下：

* 我们的计算机有五层的协议，路由器有三层，交换机有两层，集线器只有一层。
* IP 地址在网络层
* socket 是计算机提供的网络编程接口，位于传输层和应用层之间。

### 网络适配器

简称网卡。现在的计算机买来就有网卡，也不需要单独买。

网卡大致由 控制器、存储器、缓冲存储器组成。

计算机的硬件地址，也就是所谓的 mac 地址，就存储在网卡的存储器的 ROM（只读存储器） 里。

存在 ROM，意味着这个 mac 地址是不变的。mac 地址也是唯一的，是计算机在网络中的唯一标志，由计算机的生产商决定并写入。

> 那 ip 地址呢？ip 地址是可变的，存在计算机的存储器里。ip 地址怎么变？下面 DHCP 会讲到。

网卡负责 计算机 和外部网路的对接。

当网卡收到正确的帧（数据），就用中断来通知计算机。这也是为什么网卡可以看作是一个 IO设备，因为 IO 设备都是通过中断来通知计算机可以读数据的。

### 中断

简单讲一下中断吧。《计算机组成原理》中提到，某一外设数据准备就绪后，它 “主动” 向 cpu 发出请求中断信号，请求 cpu 暂时中断目前正在执行的程序而进行数据交换。当 cpu 响应这个中断时，便暂停运行主程序，并自动转移到该设备的中断服务程序。当中断服务程序（比如从外设读数据到内存）结束以后，再回到主程序继续执行。

中断的实现有硬件层面的实现，过程简单来说，就是外部设备向 cpu 请求，cpu 处理的请求。

![](/Users/jacksie/Documents/note/other/csapp lab/中断.jpg)

### 集线器/交换机/\*路由器

* 集线器

  集线器实的作用是连接多个主机，在物理层上扩展以太网。

  > 以太网是符合一定标准的局域网，即局域网的子集。

  说集线器在物理层上扩展以太网，是因为集线器只有物理层，只支持简单的数据转发。（即不处理数据，直接转发）

  集线器本身只支持广播，就是一个端口数据到了，就转发到其他所有接口。

  集线器的广播方式容易产生碰撞，而且集线器不提供碰撞检测，就只是一个无情的转发机器，碰撞检测还得靠主机执行 CSMA/CD 协议。

* 交换机

  交换机作用是在数据链路层上扩展以太网。相对的，交换机有两层结构（有的也有三层）。

  交换机具有对目的地址的过滤能力。简单来说就是不会像集线器那样广播，而是根据内置的交换表查询目的地址并转发给对应端口。

  交换机具有一定的自学习能力，数据每次经过它，都会记录发送方和接收方从而形成交换表。当然，如果交换表查不到，交换机仍然需要广播。

  交换机与主机实现全双工方式通信（就是双向通信），不会出现碰撞问题。交换机的性能远远超过集线器。

* 路由器

  路由器是连接网络和网络的一个设备，它具有三层结构。

  它主要工作是根据 分组（可简单理解成数据）的目的 ip地址 查询内部的转发表转发给下一条路由器，下一跳路由器执行相同操作。

上述三种机器在网络中的工作示例如图：

![](/Users/jacksie/Documents/note/other/csapp lab/三机.jpg)

### \*DHCP 协议 （Dynamic Host Configuration Protocol）

上面提到 ip 地址是可变的，在不同地方接入不同的网络，ip 地址一般不相同。

根据日常生活经验，我们连接某个 wifi 时，并没有手动配置 ip 地址相关的设置。这是因为现在的网络大多使用 DHCP 协议自动分配 ip 地址。

下面简单讲一下 DHCP 的过程。计算机刚接入网络时，没有被分配 ip 地址（设置为全0）也不知道 DHCP 服务器在哪里。所以第一步，它会在网络中广播“发现报文”找到 DHCP 服务器。DHCP 服务器收到请求后，会在自己的 ip 地址池取一个地址分配给该计算机，通过返回“提供报文”完成配置。

DHCP 服务器一般不会在每个网络中都设置一台，但是会设置 DHCP 中继代理。这个代理一般是一个知道 DHCP 服务器在哪点路由器，由这个路由器帮我们请求 DHCP 服务器。

分配的这个 ip 地址一般是临时的，也就是有 租用期。计算机可以通过发送续租请求，一直使用这个 ip 地址。

我们怎么知道自己的计算机有无使用这个协议？

![](/Users/jacksie/Documents/note/other/csapp lab/DHCP.png)

一般打开自己计算机的网络设置都会有的。

### \*DNS 域名系统

结合生活经验，我们上网都不会在浏览器输入 ip地址，而是输入一些网址，像“www.baidu.com“

那么域名和 ip 地址如何对应起来？答案是域名系统。

根据域名的层次分级，每一层都对应一台域名服务器。最高层的为根域名服务器，下面是顶级域名服务器和权限域名服务器。

上述的所有域名服务器会在世界各地设置。同一个域名服务器可能会有多个镜像。

为了让主机找到域名服务器，每个网络里会设置一台本地域名服务器。当主机要查询一个域名的地址，就向本地域名服务器发出请求。之后将由本地域名服务器代理完成域名的查询。

本地域名服务器首先向根域名服务器查询，跟域名服务器会给它指路。本地域名服务器继续迭代查询，直到查到地址返回给主机。

![](/Users/jacksie/Documents/note/other/csapp lab/DNS.jpg)

### accept 和 connect 之间 与 TCP 建立连接

csapp 提到了 socket 的几个函数，其中服务器要执行：getaddrinfo、socket、bind、listen、accept

客户端要执行：getaddrinfo、socket、connect。

如图：

![](/Users/jacksie/Documents/note/other/csapp lab/socket连接.png)

其中 getaddrinfo、socket、bind、listen 为客户端和服务端的初始化操作，建立连接靠 connect 和 accept 两个函数。

就代码层面来看，似乎调用两个函数就完成了连接。封装的函数帮我们隐藏了底层 tcp 连接的特性，下面介绍一下 tcp 连接方式：三次握手。

简单来说，就是客户端首先要给服务器发送连接请求，服务器收到请求给他发送一个确认。客户端收到确认需要再发送一个确认。服务器收到客户端的确认后才建立起一条连接。

这是因为 tcp 建立可靠连接的需要。如果客户端第一条连接请求经过了很长时间才到达服务器，这条请求对客户端来说可能已经过时了，是无效的。而服务器收到之后，并不知道请求是否有效。故需要客户端再次发送确认。

理论上来说，建立一条可靠连接最少需要三次请求。

![](/Users/jacksie/Documents/note/other/csapp lab/TCP连接.jpg)

### socket

关于什么是文件描述符可以参考博客：https://juejin.cn/post/6868218856671248392

csapp 书中提到，要使用 接口 建立连接，首先需要获得一个 socket 的文件描述符。

描述符标志一个被打开的文件。

既然 socket 打开了一个文件，那我们能不能在 ubuntu 上找到这个文件呢？

显然是可以的。

首先需要进入管理员模式，否则那个文件的目录都进不去。

然后进入文件路径：/proc/{pid}/fd 

pid 需要切换成具体的进程号。目录名字 fd 表示打开的文件集合。

这个目录下的文件都是此进程打开的文件。如果这个进程跑的是一个网络服务，那么就能找到 socket 字样的文件，这个文件就是 socket 文件。

客户端发过来的字节流都会被放在这个文件里，而我们服务器读取也是从这个文件中读取。

所以对于应用进程来说，网络通信通过写文件和读文件实现。

