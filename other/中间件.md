### 中间件

今天的主题是业务中间件。

#### 1. redis

* 为何使用？

  redis 完全基于内存，底层实现是哈希表，并发模型是单进程单线程。

  优点很明显了，就是足够快，不需要像 mysql 去查各种表。

  另一个优点就是单线程的模式足够小，即使在性能不那么好的机器上也能稳定发挥。

  redis 应该是我们团队最常使用的中间件，~~（我好像没见过团队用其他的）~~

  我们常用来做 mysql 的缓存、消息队列、有时候会有些异步进程通讯的操作。

  不过需要注意一点，redis 是完全基于内存的，如果突然断电了，redis 存的信息会全部丢失。所以存到 redis 的信息，都需要从数据库中得到。

  > 什么叫缓存？就是我们把 mysql 中的信息存到 redis。为什么要做缓存？因为 redis 够快，当查询比较多的信息时，性能提升较大。（团队里最典型的应用就是匣子的课表服务）此外，有一些信息可能是 mysql 本身不方便存储的，（要多建表比较麻烦，例如工作台的 project 服务）我们可以通过查表计算出这些信息，并存到redis。

* 如何安装？

  直接上官网就好了：https://redis.io/download

  应该没什么难度。进入 src 文件夹后，有 redis-cli 和 redis-server 两个可执行文件

  一个是启动 redis 的客户端，一个是启动 redis 的服务端

  如果不想每次启动 redis 都打开文件夹怎么办呢？可以设置环境变量。

  不过呢，redis 给我们提供了 Makefile ，我们可以看看 README.md：

  ```markdown
  Installing Redis
  -----------------
  
  In order to install Redis binaries into /usr/local/bin, just use:
  
      % make install
  
  You can use `make PREFIX=/some/other/directory install` if you wish to use a
  different destination.
  ```

  直接输入指令 `make install` 就可以了。

* 如何使用？

  * 基本指令

    这里就不一一列举了，给出网站，基本都有: http://doc.redisfans.com/

  * 基本数据类型

    和 mysql 不同的是，redis 是key-value 数据库。也就是相当于一个大型的哈希表。（整个存储结构也是，不同数据结构的区别就在于 key 对应的结构不同）

    在这样一个数据库中，有五种基本的数据类型：string、set、zset、list、hash 五种。

    分别是 字符串、集合、有序集合、哈希表。

    * string

      我们可以用简单命令`set [key] [value]`来存储一个 string。其中 key 是这个字符串的键，是它在 redis 中的唯一标志。value 是字符串的值，简单来说就是字符串本身。

      字符串是最泛用的数据类型，书上提到了可以用来缓存用户信息。就是将用户信息的结构体序列化成 json 格式，并作为字符串形式存入 redis。

      **使用场景：**

      具体在什么场景下能缓存用户信息，我现在还没遇到过。不过呢，在我们团队的工作台中，用到了 string 来缓存过期 token，也就是做 token 的黑名单。

    * set

      我们可以用指令 `sadd books golang`来简单创建一个集合。这个集合的键是 books，集合对应的成员有一个，叫做 golang。我们可以继续通过`sadd books [member]`来添加成员。当一个集合中的成员个数为 0 时，集合的内存会被自动回收。

      集合可以看作是一个特殊的哈希表，只不过哈希表里面所有的 value 都是 NULL。

      **使用场景：**

      书上提到，set 可以用来存储用户中奖信息。这是因为用到了集合的自动去重功能（其实就是哈希表的去重）。所以一个用户不可能中奖两次。在团队实际应用中，工作台的回收站就有用到 set，下面就说说具体实现：

      当删除一个文件时，要么删文件，要么删文件夹。mysql 只存储被删的对象本身，后面的任务交给定时任务做。如果是文件夹，定时任务需要遍历出它的所有子文件夹和子文件，并存到 redis。如果是文件本身就直接存到 redis。这样做的一个好处就是我们不用多次插入数据库。如果每次删除文件夹都需要递归遍历修改数据库，会非常非常的慢。如果只是插入这个被删除的对象本身，而遍历拿出子文件夹的过程交给子协程定时任务做，会快得多。（所谓子协程就是 go 开启的函数）

    * zset

      我们可以通过`zadd [key] [score] [member]`来创建一个有序集合，并向其中存一个带有分数 score 属性的成员。同 set 一样，这条指令可多次使用，插入多个成员。当集合中成员个数归 0，内存被自动回收。

      有序集合是 redis 最有特色的数据结构，它典型的作用就是能快速给出降序升序排序，而且插入数据和获取数据都非常快。虽然我现在遇到的开发场景都太小，还没在实战中用过。它底层实现是经典的跳跃列表，也是经常被面试官问到的东西。当然这里只是介绍 redis，并不会讲到底层的东西。

      **使用场景：**

      书上提到，zset 可以用来存储粉丝列表，member 值是粉丝的用户 ID，score 是关注事件，key 可以是这个用户的 ID。这样我们可以对粉丝按照关注时间进行排序。zset 还可以用来存学生成绩，score 是成绩，就可以按照成绩排序。

    * hash 和 list

      list可以实现简单的消息队列。这两个我没有深入了解过，就不多讲了。

  * pub-sub

    翻译过来就是 发布者-接受者。这是 redis 里面支持消息多播的机制。什么叫消息多播？就是一个发布者发布信息可以被多个接受者收到。其实前面的 list 类型就可以实现消息队列，（看作一个队列）但是不支持消息多播，所以就有了 pub-sub 的机制。

    **使用场景：**

    pub-sub可以应用于实现实时聊天的功能和博客的粉丝文章的推送。我们团队工作台用过这个来实现进程间的异步通信。

    （案例，多人聊天室）

  * go-redis 包

    这是团队用得比较多的包。https://github.com/go-redis/redis

#### 2. kafka

* 如何安装？
* 如何使用？

#### 3. Rabbitmq

* 如何安装？
* 如何使用？